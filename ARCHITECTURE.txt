DAG Execution Engine - Architecture
====================================

EXECUTION FLOW:
===============

┌─────────────────────────────────────────────────────────────────┐
│                        Client (React Canvas)                     │
│                   Sends Workflow JSON via POST                   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      WorkflowController                          │
│                  REST API Endpoint Handler                       │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   WorkflowExecutionService                       │
│              Orchestrates Validation & Execution                 │
└────────────┬───────────────────────────────────┬────────────────┘
             │                                   │
             ▼                                   ▼
┌─────────────────────────┐      ┌─────────────────────────────────┐
│   GraphValidator        │      │    ExecutionPlanner             │
│   - Validate nodes      │      │    - Build adjacency list       │
│   - Validate edges      │      │    - Topological sort           │
│   - Detect cycles       │      │    - Detect parallel branches   │
│   - Check executors     │      │    - Create Spring Batch Job    │
└─────────────────────────┘      └────────────┬────────────────────┘
                                              │
                                              ▼
                                 ┌────────────────────────────────┐
                                 │  Spring Batch Job              │
                                 │  ┌──────────────────────────┐  │
                                 │  │    Flow 1 (Parallel)     │  │
                                 │  │  ├─ Step 1              │  │
                                 │  │  ├─ Step 2              │  │
                                 │  │  └─ Step 3              │  │
                                 │  └──────────────────────────┘  │
                                 │  ┌──────────────────────────┐  │
                                 │  │    Flow 2 (Parallel)     │  │
                                 │  │  ├─ Step 4              │  │
                                 │  │  └─ Step 5              │  │
                                 │  └──────────────────────────┘  │
                                 └────────────┬───────────────────┘
                                              │
                                              ▼
                           ┌──────────────────────────────────────┐
                           │     For Each Step:                   │
                           │  NodeExecutorRegistry.getExecutor()  │
                           └────────────┬─────────────────────────┘
                                        │
                                        ▼
                           ┌────────────────────────────────────┐
                           │      NodeExecutor                  │
                           │      - createReader()              │
                           │      - createProcessor()           │
                           │      - createWriter()              │
                           └────────────┬───────────────────────┘
                                        │
              ┌─────────────────────────┼─────────────────────────┐
              │                         │                         │
              ▼                         ▼                         ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌────────────────────┐
│ FailureHandler      │   │ MetricsCollector    │   │ Step Execution     │
│ - Retry policies    │   │ - Execution time    │   │ - Read items       │
│ - Skip policies     │   │ - Read/Write count  │   │ - Process items    │
│ - Routing logic     │   │ - Error count       │   │ - Write items      │
└─────────────────────┘   └─────────────────────┘   └────────────────────┘


COMPONENT RELATIONSHIPS:
========================

WorkflowDefinition
    ├── nodes: List<NodeDefinition>
    │       ├── id: String
    │       ├── type: String
    │       ├── config: JsonNode
    │       ├── executionHints: ExecutionHints
    │       ├── metrics: MetricsConfig
    │       └── onFailure: FailurePolicy
    │
    └── edges: List<Edge>
            ├── source: String
            ├── target: String
            ├── sourceHandle: String
            ├── targetHandle: String
            └── isControl: boolean


DAG ANALYSIS PROCESS:
=====================

1. Parse Workflow JSON
   └─> WorkflowDefinition

2. Build Adjacency List
   └─> Map<NodeId, List<TargetNodeIds>>

3. Calculate In-Degrees
   └─> Map<NodeId, IncomingEdgeCount>

4. Topological Sort (Kahn's Algorithm)
   └─> Ordered list of nodes OR cycle detection

5. Identify Source Nodes
   └─> Nodes with in-degree = 0 (excluding Start)

6. Detect Parallel Branches
   └─> Nodes with multiple outgoing edges

7. Build Execution Plan
   ├─> Sequential flows for linear chains
   ├─> Parallel flows for independent branches
   └─> Split/join patterns


SPRING BATCH INTEGRATION:
==========================

NodeDefinition ──────────┐
                         │
NodeExecutor ────────────┼──> Step
                         │   ├── ItemReader<I>
ExecutionHints ──────────┤   ├── ItemProcessor<I,O>
                         │   ├── ItemWriter<O>
FailurePolicy ───────────┤   ├── RetryPolicy
                         │   ├── SkipPolicy
MetricsConfig ───────────┘   └── StepExecutionListener

Multiple Steps ─────────────> Flow (sequential or parallel)

Multiple Flows ─────────────> Job


KEY DESIGN DECISIONS:
=====================

1. NO Database for Workflow Data
   - Only H2 for Spring Batch metadata (JobRepository)
   - Workflows are ephemeral (passed via API)

2. Generic Execution Framework
   - No node-specific implementations
   - NodeExecutor interface for extensibility
   - Registry pattern for dynamic registration

3. Separation of Concerns
   - Graph analysis (DagUtils)
   - Validation (GraphValidator)
   - Planning (ExecutionPlanner)
   - Execution (Spring Batch)
   - Metrics (MetricsCollector)
   - Failure Handling (FailureHandler)

4. Control Flow vs Data Flow
   - isControl flag distinguishes edge types
   - Control edges: determine step transitions
   - Data edges: determine processing order

5. Start Node Handling
   - Start nodes ignored at runtime (metadata only)
   - Source nodes (in-degree 0) are actual entry points

6. Parallel Execution Strategy
   - Independent branches execute in parallel
   - Uses TaskExecutor (async)
   - Respects ExecutionHints.mode

7. Failure Handling Hierarchy
   - Node-level policies
   - Step-level listeners
   - Job-level error handling

8. Metrics Collection
   - Automatic via StepExecutionListener
   - Configurable per-node
   - In-memory storage
